<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DMG CRM Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #0f1b2d;
    --navy2: #162336;
    --navy3: #1e3050;
    --blue: #1a6bff;
    --blue-light: #4d8fff;
    --cyan: #00c8e0;
    --surface: #1a2d45;
    --surface2: #213554;
    --border: rgba(255,255,255,0.07);
    --border2: rgba(255,255,255,0.12);
    --text: #e8edf5;
    --text2: #8fa3bd;
    --text3: #5a7a99;
    --green: #22d992;
    --green-dim: rgba(34,217,146,0.12);
    --yellow: #f5c842;
    --yellow-dim: rgba(245,200,66,0.12);
    --red: #ff4d6a;
    --red-dim: rgba(255,77,106,0.12);
    --orange: #ff8a3d;
    --orange-dim: rgba(255,138,61,0.12);
    --purple: #a78bfa;
    --radius: 12px;
    --radius-sm: 8px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--navy);
    color: var(--text);
    min-height: 100vh;
    padding: 20px;
  }

  .container {
    max-width: 1800px;
    margin: 0 auto;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .header-title {
    font-family: 'Syne', sans-serif;
    font-size: 32px;
    font-weight: 800;
    color: var(--text);
  }

  .header-subtitle {
    font-size: 14px;
    color: var(--text3);
    margin-top: 4px;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
  }

  .btn-primary {
    background: var(--blue);
    color: white;
  }

  .btn-primary:hover {
    background: var(--blue-light);
    transform: translateY(-1px);
  }

  .filters {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .filter-input {
    padding: 10px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    flex: 1;
    min-width: 250px;
  }

  .filter-select {
    padding: 10px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    cursor: pointer;
  }

  .table-container {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead {
    background: var(--navy2);
  }

  th {
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text3);
    border-bottom: 1px solid var(--border);
  }

  tbody tr {
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
  }

  tbody tr:hover {
    background: rgba(255,255,255,0.03);
  }

  td {
    padding: 14px 12px;
    font-size: 13px;
    color: var(--text2);
  }

  .product-badge {
    display: inline-block;
    padding: 4px 10px;
    background: var(--blue-dim);
    border: 1px solid rgba(26,107,255,0.25);
    border-radius: 6px;
    color: var(--blue-light);
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
  }

  .owner-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 12px;
    color: var(--text2);
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
  }

  .status-complete {
    background: var(--green-dim);
    border: 1px solid rgba(34,217,146,0.25);
    color: var(--green);
  }

  .status-in-progress {
    background: var(--yellow-dim);
    border: 1px solid rgba(245,200,66,0.25);
    color: var(--yellow);
  }

  .status-not-started {
    background: var(--red-dim);
    border: 1px solid rgba(255,77,106,0.25);
    color: var(--red);
  }

  .status-on-hold {
    background: rgba(138,147,166,0.12);
    border: 1px solid rgba(138,147,166,0.25);
    color: var(--text3);
  }

  .jira-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: rgba(26,107,255,0.12);
    border: 1px solid rgba(26,107,255,0.25);
    border-radius: 6px;
    color: var(--blue-light);
    text-decoration: none;
    font-size: 11px;
    font-weight: 600;
    transition: all 0.15s;
  }

  .jira-link:hover {
    background: rgba(26,107,255,0.22);
    transform: translateY(-1px);
  }

  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(8px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }

  .modal.open {
    opacity: 1;
    pointer-events: all;
  }

  .modal-content {
    background: var(--navy2);
    border: 1px solid var(--border2);
    border-radius: 16px;
    width: 90%;
    max-width: 900px;
    max-height: 85vh;
    overflow-y: auto;
    padding: 32px;
    transform: translateY(24px);
    transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  }

  .modal.open .modal-content {
    transform: translateY(0);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .modal-title {
    font-family: 'Syne', sans-serif;
    font-size: 24px;
    font-weight: 800;
    color: var(--text);
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text3);
    transition: color 0.15s;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-btn:hover {
    color: var(--text);
  }

  .form-section {
    margin-bottom: 24px;
  }

  .form-label {
    display: block;
    font-weight: 600;
    font-size: 13px;
    color: var(--text2);
    margin-bottom: 8px;
  }

  .form-input,
  .form-textarea,
  .form-select {
    width: 100%;
    padding: 12px 16px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
  }

  .form-textarea {
    min-height: 100px;
    resize: vertical;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .notes-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-top: 24px;
  }

  .notes-header {
    font-weight: 600;
    font-size: 14px;
    color: var(--text);
    margin-bottom: 16px;
  }

  .note-item {
    background: var(--navy3);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px;
    margin-bottom: 12px;
  }

  .note-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .note-date {
    font-size: 11px;
    color: var(--text3);
    font-weight: 600;
  }

  .note-text {
    font-size: 13px;
    color: var(--text2);
    line-height: 1.6;
  }

  .add-note-form {
    display: flex;
    gap: 12px;
    margin-top: 16px;
  }

  .note-input {
    flex: 1;
    padding: 12px 16px;
    background: var(--navy3);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
  }

  .btn-add-note {
    padding: 12px 24px;
    background: var(--blue);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-add-note:hover {
    background: var(--blue-light);
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .info-item {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px;
  }

  .info-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text3);
    font-weight: 600;
    margin-bottom: 6px;
  }

  .info-value {
    font-size: 14px;
    color: var(--text);
    font-weight: 500;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text3);
  }

  .empty-icon {
    font-size: 48px;
    margin-bottom: 12px;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
  }

  .stat-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text3);
    font-weight: 600;
    margin-bottom: 8px;
  }

  .stat-value {
    font-family: 'Syne', sans-serif;
    font-size: 32px;
    font-weight: 800;
    color: var(--blue-light);
  }

  .export-btn {
    padding: 10px 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .export-btn:hover {
    background: var(--surface2);
    transform: translateY(-1px);
  }

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    body {
      padding: 12px;
    }

    .header {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 20px;
    }

    .header-title {
      font-size: 24px;
    }

    .header-subtitle {
      font-size: 13px;
    }

    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      padding: 16px;
    }

    .stat-label {
      font-size: 10px;
    }

    .stat-value {
      font-size: 24px;
    }

    .filters {
      flex-direction: column;
      gap: 10px;
    }

    .filter-input,
    .filter-select {
      width: 100%;
      min-width: auto;
    }

    /* Hide table on mobile, show card view instead */
    .table-container {
      display: none;
    }

    .mobile-cards {
      display: block;
    }

    .task-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .task-card:active {
      transform: scale(0.98);
      background: var(--surface2);
    }

    .task-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      gap: 12px;
    }

    .task-card-title {
      font-weight: 600;
      font-size: 15px;
      color: var(--text);
      flex: 1;
    }

    .task-card-body {
      font-size: 13px;
      color: var(--text3);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .task-card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .task-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .task-card-owners {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      color: var(--text3);
    }

    .modal-content {
      width: 95%;
      max-height: 90vh;
      padding: 20px;
    }

    .modal-title {
      font-size: 20px;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .info-grid {
      grid-template-columns: 1fr;
    }

    .add-note-form {
      flex-direction: column;
    }

    .note-input {
      width: 100%;
    }

    .btn-add-note {
      width: 100%;
    }
  }

  /* Desktop only - show table */
  @media (min-width: 769px) {
    .mobile-cards {
      display: none;
    }
  }

  /* ‚îÄ‚îÄ Tag input (multi-select) ‚îÄ‚îÄ */
  .tag-dropdown {
    position: absolute; top: calc(100% + 4px); left: 0; right: 0;
    background: var(--navy2); border: 1px solid var(--border2);
    border-radius: var(--radius-sm); z-index: 500;
    max-height: 220px; overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  }
  .tag-dropdown-item {
    padding: 9px 14px; font-size: 13px; color: var(--text2);
    cursor: pointer; transition: background 0.1s;
  }
  .tag-dropdown-item:hover, .tag-dropdown-item.active { background: rgba(26,107,255,0.15); color: var(--text); }
  .tag-input-outer { position: relative; }
  .tag-input-wrap {
    display: flex; flex-wrap: wrap; gap: 6px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 7px 10px; min-height: 44px;
    cursor: text; transition: border-color 0.15s; align-items: center;
  }
  .tag-input-wrap:focus-within { border-color: var(--blue); }
  .tag-pill {
    display: inline-flex; align-items: center; gap: 5px;
    background: rgba(26,107,255,0.15); border: 1px solid rgba(26,107,255,0.3);
    color: var(--blue-light); border-radius: 20px;
    padding: 2px 8px; font-size: 12px; white-space: nowrap;
  }
  .tag-pill-remove { cursor: pointer; color: var(--text3); font-size: 11px; margin-left: 2px; line-height: 1; }
  .tag-pill-remove:hover { color: var(--red); }
  .tag-text-input {
    border: none; background: transparent; outline: none;
    font-family: 'DM Sans', sans-serif; font-size: 13px;
    color: var(--text); min-width: 100px; flex: 1;
  }
  .tag-text-input::placeholder { color: var(--text3); }

  /* ‚îÄ‚îÄ App layout with sidebar ‚îÄ‚îÄ */
  body { padding: 0 !important; }
  .app-layout { display: flex; min-height: 100vh; }

  .sidebar {
    width: 220px; min-width: 220px;
    background: var(--navy2);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    position: fixed; top: 0; left: 0; bottom: 0;
    z-index: 50; overflow-y: auto;
  }
  .sidebar::-webkit-scrollbar { width: 4px; }
  .sidebar::-webkit-scrollbar-thumb { background: var(--surface2); }

  .sidebar-logo {
    padding: 20px 18px 16px;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-logo-title {
    font-family: 'Syne', sans-serif;
    font-size: 16px; font-weight: 800;
    color: var(--text); line-height: 1.2;
  }
  .sidebar-logo-sub { font-size: 11px; color: var(--text3); margin-top: 3px; }

  .sidebar-section-label {
    font-size: 10px; font-weight: 600;
    letter-spacing: 1.4px; text-transform: uppercase;
    color: var(--text3); padding: 16px 18px 6px;
  }

  .sidebar-nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 18px; cursor: pointer;
    font-size: 13px; color: var(--text2);
    border-left: 2px solid transparent;
    transition: all 0.15s;
  }
  .sidebar-nav-item:hover { background: rgba(255,255,255,0.04); color: var(--text); }
  .sidebar-nav-item.active {
    background: rgba(26,107,255,0.12);
    color: var(--blue-light);
    border-left-color: var(--blue);
  }
  .sidebar-nav-icon { font-size: 15px; width: 20px; text-align: center; flex-shrink: 0; }
  .sidebar-nav-badge {
    margin-left: auto;
    font-size: 10px; font-weight: 600;
    background: rgba(138,163,189,0.15);
    color: var(--text3);
    padding: 1px 7px; border-radius: 10px;
  }

  .sidebar-stats {
    margin-top: auto;
    padding: 14px 18px;
    border-top: 1px solid var(--border);
  }
  .sidebar-stat-row {
    display: flex; justify-content: space-between;
    font-size: 12px; color: var(--text3); margin-bottom: 5px;
  }
  .sidebar-stat-row strong { color: var(--text2); }

  .main-content {
    margin-left: 220px;
    flex: 1; min-width: 0;
    padding: 20px;
  }

  /* Archive view */
  #archive-view { display: none; }
  #archive-view.active { display: block; }
  #main-view.hidden { display: none; }

  .archive-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 18px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: border-color 0.15s;
    display: flex; align-items: center; gap: 16px;
  }
  .archive-card:hover { border-color: var(--border2); }

  /* Mobile: hide sidebar, restore padding */
  @media (max-width: 768px) {
    .sidebar { display: none; }
    .main-content { margin-left: 0; }
    body { padding: 12px !important; }
  }

  body:not(.is-admin) .admin-only { display: none !important; }
  .auth-overlay { position:fixed;inset:0;background:rgba(10,18,30,0.97);backdrop-filter:blur(12px);z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.3s; }
  .auth-overlay.open { opacity:1;pointer-events:all; }
  /* Hide entire app until authenticated */
  .app-layout { display:none !important; }
  .app-layout.authenticated { display:flex !important; }
  .auth-card { background:#162336;border:1px solid rgba(255,255,255,0.12);border-radius:20px;width:100%;max-width:380px;padding:36px 32px 28px;transform:translateY(24px);transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 24px 60px rgba(0,0,0,0.5); }
  .auth-overlay.open .auth-card { transform:translateY(0); }
  .auth-logo-icon { font-size:36px;text-align:center;display:block;margin-bottom:8px; }
  .auth-title { font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:#e8edf5;text-align:center;margin-bottom:4px; }
  .auth-subtitle { font-size:13px;color:#5a7a99;text-align:center;margin-bottom:24px; }
  .auth-field { margin-bottom:14px; }
  .auth-label { display:block;font-size:11px;font-weight:600;letter-spacing:0.8px;text-transform:uppercase;color:#5a7a99;margin-bottom:6px; }
  .auth-input { width:100%;background:#1a2d45;border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:10px 14px;font-family:'DM Sans',sans-serif;font-size:14px;color:#e8edf5;outline:none;transition:border-color 0.15s; }
  .auth-input:focus { border-color:#1a6bff; }
  .auth-input::placeholder { color:#5a7a99; }
  .auth-btn { width:100%;background:#1a6bff;color:#fff;border:none;border-radius:8px;padding:11px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;margin-top:6px;transition:background 0.15s; }
  .auth-btn:hover { background:#4d8fff; }
  .auth-btn:disabled { opacity:0.6;cursor:not-allowed; }
  .auth-error { background:rgba(255,77,106,0.12);border:1px solid rgba(255,77,106,0.3);border-radius:8px;padding:9px 12px;font-size:12.5px;color:#ff4d6a;margin-bottom:14px;display:none; }
  .auth-error.show { display:block; }
  .admin-badge { display:inline-flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;font-size:12px;font-weight:600;background:rgba(34,217,146,0.12);color:#22d992;border:1px solid rgba(34,217,146,0.25);cursor:pointer; }
  .admin-lock-btn { display:inline-flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;font-size:12px;font-weight:600;background:rgba(138,163,189,0.1);color:#5a7a99;border:1px solid rgba(255,255,255,0.12);cursor:pointer;transition:all 0.15s; }
  .admin-lock-btn:hover { background:rgba(26,107,255,0.12);color:#4d8fff; }
</style>
</head>
<body>
<div class="app-layout">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-title">DMG CRM<br>Tracker</div>
      <div class="sidebar-logo-sub">Track all CRM projects and tasks</div>
    </div>

    <div class="sidebar-section-label">Navigation</div>
    <div class="sidebar-nav-item active" id="snav-all" onclick="showView('all')">
      <span class="sidebar-nav-icon">üìã</span>
      <span>All Projects</span>
    </div>
    <div class="sidebar-nav-item admin-only" id="snav-archive" onclick="showView('archive')">
      <span class="sidebar-nav-icon">üóÇÔ∏è</span>
      <span>Archive</span>
      <span class="sidebar-nav-badge" id="archive-badge">0</span>
    </div>

    <div class="sidebar-section-label">Filter by Status</div>
    <div class="sidebar-nav-item" id="snav-all-status" onclick="setSidebarFilter('all')">
      <span class="sidebar-nav-icon">üîµ</span>
      <span>All Tasks</span>
    </div>
    <div class="sidebar-nav-item" id="snav-inprogress" onclick="setSidebarFilter('In Progress')">
      <span class="sidebar-nav-icon">üü°</span>
      <span>In Progress</span>
    </div>
    <div class="sidebar-nav-item" id="snav-notstarted" onclick="setSidebarFilter('Not Started')">
      <span class="sidebar-nav-icon">üî¥</span>
      <span>Not Started</span>
    </div>
    <div class="sidebar-nav-item" id="snav-complete" onclick="setSidebarFilter('Complete')">
      <span class="sidebar-nav-icon">üü¢</span>
      <span>Complete</span>
    </div>
    <div class="sidebar-nav-item" id="snav-onhold" onclick="setSidebarFilter('On Hold')">
      <span class="sidebar-nav-icon">üü†</span>
      <span>On Hold</span>
    </div>

    <div class="sidebar-stats">
      <div class="sidebar-stat-row"><span>Total Tasks</span><strong id="sb-total">0</strong></div>
      <div class="sidebar-stat-row"><span>Complete</span><strong id="sb-complete" style="color:var(--green)">0</strong></div>
      <div class="sidebar-stat-row"><span>In Progress</span><strong id="sb-progress" style="color:var(--yellow)">0</strong></div>
      <div class="sidebar-stat-row"><span>Not Started</span><strong id="sb-notstarted" style="color:var(--red)">0</strong></div>
    </div>
  </aside>

  <!-- Main content -->
  <div class="main-content">
  <div id="main-view">
  <div class="container" style="max-width:100%;padding:0">
    <div class="header">
      <div>
        <div class="header-title">DMG CRM Tracker</div>
        <div class="header-subtitle">Track all CRM projects and tasks in one place</div>
      </div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importData(event)">
        <button class="export-btn admin-only" onclick="document.getElementById('import-file').click()">üì§ Import</button>
        <button class="export-btn" onclick="exportToJSON()">üì• Export</button>
        <button class="btn btn-primary admin-only" onclick="openAddModal()">+ Add Task</button>
        <div id="admin-logged-in" style="display:none">
          <span class="admin-badge" onclick="doLogout()">üü¢ Admin ¬∑ Sign out</span>
        </div>
        <div id="admin-logged-out">
          <span class="admin-lock-btn" onclick="showLoginModal()">üîí Admin Login</span>
        </div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Tasks</div>
        <div class="stat-value" id="stat-total">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Complete</div>
        <div class="stat-value" style="color: var(--green)" id="stat-complete">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">In Progress</div>
        <div class="stat-value" style="color: var(--yellow)" id="stat-progress">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Not Started</div>
        <div class="stat-value" style="color: var(--red)" id="stat-not-started">0</div>
      </div>
    </div>

    <div class="filters">
      <input type="text" class="filter-input" id="search-input" placeholder="üîç Search tasks..." oninput="filterTasks()">
      <select class="filter-select" id="product-filter" onchange="filterTasks()">
        <option value="">All Products</option>
      </select>
      <select class="filter-select" id="status-filter" onchange="filterTasks()">
        <option value="">All Statuses</option>
        <option value="Complete">Complete</option>
        <option value="In Progress">In Progress</option>
        <option value="Not Started">Not Started</option>
        <option value="On Hold">On Hold</option>
      </select>
      <select class="filter-select" id="owner-filter" onchange="filterTasks()">
        <option value="">All Owners</option>
      </select>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th style="width: 120px;">Product</th>
            <th>Subject</th>
            <th style="width: 140px;">CRM Owner</th>
            <th style="width: 140px;">Marketing Owner</th>
            <th style="width: 120px;">Status</th>
            <th style="width: 110px;">Due Date</th>
            <th style="width: 40px;"></th>
          </tr>
        </thead>
        <tbody id="tasks-tbody">
          <tr>
            <td colspan="7" class="empty-state">
              <div class="empty-icon">üìã</div>
              <div>No tasks yet. Click "Add Task" to get started.</div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Mobile Card View -->
    <div class="mobile-cards" id="mobile-cards">
      <div class="empty-state" style="padding: 40px 20px;">
        <div class="empty-icon">üìã</div>
        <div>No tasks yet. Click "Add Task" to get started.</div>
      </div>
    </div>
  </div><!-- /container -->
  </div><!-- /main-view -->

  <!-- Archive View -->
  <div id="archive-view">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div>
        <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800">üóÇÔ∏è Archive</div>
        <div style="font-size:13px;color:var(--text3);margin-top:4px">Completed tasks with due date 7+ days ago or no due date</div>
      </div>
    </div>
    <div id="archive-list"></div>
  </div>

  </div><!-- /main-content -->
</div><!-- /app-layout -->

  <!-- Task Detail Modal -->
  <div class="modal" id="task-modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">Task Details</div>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>

      <!-- Notes section moved to top for existing projects -->
      <div class="notes-section" id="notes-section-top" style="display: none; margin-bottom: 24px;">
        <div class="notes-header">üìù Recent Notes & Updates</div>
        <div id="notes-list-top"></div>
        <div class="add-note-form">
          <input type="text" class="note-input" id="new-note-input-top" placeholder="Add a note...">
          <button class="btn-add-note" onclick="addNote()">Add Note</button>
        </div>
      </div>

      <div class="form-section">
        <div class="form-row">
          <div>
            <label class="form-label">DMG Product</label>
            <div class="tag-input-outer">
              <div class="tag-input-wrap" id="product-tag-wrap" onclick="document.getElementById('product-tag-input').focus()">
                <input class="tag-text-input" id="product-tag-input" placeholder="Select or type a product‚Ä¶"
                  onkeydown="handleProductKey(event)" oninput="filterProductDropdown()" 
                  onfocus="showProductDropdown()" autocomplete="off" type="text">
              </div>
              <div class="tag-dropdown" id="product-dropdown" style="display:none"></div>
            </div>
          </div>
          <div>
            <label class="form-label">Status</label>
            <select class="form-select" id="input-status">
              <option value="Not Started">Not Started</option>
              <option value="In Progress">In Progress</option>
              <option value="Complete">Complete</option>
              <option value="On Hold">On Hold</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <label class="form-label">Subject</label>
        <input type="text" class="form-input" id="input-subject" placeholder="Brief description of the task">
      </div>

      <div class="form-section">
        <label class="form-label">Description</label>
        <textarea class="form-textarea" id="input-description" placeholder="Detailed description of the task"></textarea>
      </div>

      <div class="form-section">
        <div class="form-row">
          <div>
            <label class="form-label">CRM Owner</label>
            <div class="tag-input-wrap" id="crm-owner-tag-wrap" onclick="document.getElementById('crm-owner-tag-input').focus()">
              <input class="tag-text-input" id="crm-owner-tag-input" placeholder="Type and press Enter‚Ä¶"
                onkeydown="handleTagKey(event,'crmOwners')" type="text">
            </div>
          </div>
          <div>
            <label class="form-label">Marketing Owner</label>
            <div class="tag-input-wrap" id="mkt-owner-tag-wrap" onclick="document.getElementById('mkt-owner-tag-input').focus()">
              <input class="tag-text-input" id="mkt-owner-tag-input" placeholder="Type and press Enter‚Ä¶"
                onkeydown="handleTagKey(event,'mktOwners')" type="text">
            </div>
          </div>
        </div>
      </div>

      <div class="form-section">
        <div class="form-row">
          <div>
            <label class="form-label">Due/Send Date</label>
            <input type="date" class="form-input" id="input-due-date">
          </div>
          <div>
            <label class="form-label">Risk Level</label>
            <select class="form-select" id="input-risk">
              <option value="">None</option>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <label class="form-label">Data Required</label>
        <textarea class="form-textarea" id="input-data-required" placeholder="List any data requirements" style="min-height: 80px;"></textarea>
      </div>

      <div class="form-section">
        <label class="form-label">Jira Link</label>
        <input type="url" class="form-input" id="input-jira" placeholder="https://jira.example.com/browse/PROJ-123">
      </div>

      <div style="display: flex; gap: 12px; margin-top: 28px;">
        <button class="btn btn-primary" onclick="saveTask()" style="flex: 1;">
          <span id="save-btn-text">Save Task</span>
        </button>
        <button class="btn export-btn" onclick="closeModal()" style="flex: 0 0 auto;">Cancel</button>
        <button class="btn" onclick="deleteTask()" id="delete-btn" style="background: var(--red); color: white; flex: 0 0 auto; display: none;">Delete</button>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script>
// ‚îÄ‚îÄ Firebase init ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyDdDCU32Kv1nDwz5l33tIkQ37W6DznV3sg",
  authDomain: "gv-project-tracker-3686a.firebaseapp.com",
  projectId: "gv-project-tracker-3686a",
  storageBucket: "gv-project-tracker-3686a.firebasestorage.app",
  messagingSenderId: "449784720463",
  appId: "1:449784720463:web:027c8e6ff4abb090e98e3a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
const DATA_DOC = db.collection('crm').doc('data');
let isSyncing = false;
let isAdmin = false;

// ‚îÄ‚îÄ Data store ‚îÄ‚îÄ
let tasks = [];
let editingTaskId = null;

// ‚îÄ‚îÄ Tag input state ‚îÄ‚îÄ
const tagState = { products: [], crmOwners: [], mktOwners: [] };
const tagConfig = {
  products:  { wrap: 'product-tag-wrap',   input: 'product-tag-input' },
  crmOwners: { wrap: 'crm-owner-tag-wrap', input: 'crm-owner-tag-input' },
  mktOwners: { wrap: 'mkt-owner-tag-wrap', input: 'mkt-owner-tag-input' }
};

// ‚îÄ‚îÄ Product dropdown ‚îÄ‚îÄ
const PRODUCT_LIST = ["ALL", "The Mail Subscription", "Mail Subscriptions", "The Mail", "Partners", "Twipe", "The Mail+", "MyMail", "Mail+ Editions", "Mail+", "MOL", "Circulation", "Mail Essential", "Mail Rewards", "Mail Online", "Print", "YOU", "MOL Newsletters", "iMovo", "Daily Mail", "Mail Shop", "inewspaper", "YouBeauty", "Mail Travel", "Mail Finance", "YOU Beauty", "MOL Travel", "MOL Advertising", "NS", "METRO", "Metro Travel", "TiM", "This Is Money", "Morning Brief", "Palace Confidential", "Crime Desk", "The Knowledge", "i", "Longer-term Planning/Projects"];
let dropdownActiveIdx = -1;

function showProductDropdown() {
  filterProductDropdown();
  document.getElementById('product-dropdown').style.display = 'block';
}

function hideProductDropdown() {
  setTimeout(() => { document.getElementById('product-dropdown').style.display = 'none'; dropdownActiveIdx = -1; }, 150);
}

function filterProductDropdown() {
  const val = document.getElementById('product-tag-input').value.toLowerCase();
  const dd = document.getElementById('product-dropdown');
  const filtered = PRODUCT_LIST.filter(p => p.toLowerCase().includes(val) && !tagState.products.includes(p));
  if (!filtered.length) { dd.style.display = 'none'; return; }
  dd.style.display = 'block';
  dd.innerHTML = filtered.map((p, i) => 
    `<div class="tag-dropdown-item" onmousedown="selectProduct('${p.replace(/'/g, "\'")}')" data-idx="${i}">${p}</div>`
  ).join('');
  dropdownActiveIdx = -1;
}

function selectProduct(val) {
  if (val && !tagState.products.includes(val)) {
    tagState.products.push(val);
    renderTagPills('products');
  }
  document.getElementById('product-tag-input').value = '';
  document.getElementById('product-dropdown').style.display = 'none';
  dropdownActiveIdx = -1;
}

function handleProductKey(e) {
  const dd = document.getElementById('product-dropdown');
  const items = dd.querySelectorAll('.tag-dropdown-item');
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    dropdownActiveIdx = Math.min(dropdownActiveIdx + 1, items.length - 1);
    items.forEach((el, i) => el.classList.toggle('active', i === dropdownActiveIdx));
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    dropdownActiveIdx = Math.max(dropdownActiveIdx - 1, 0);
    items.forEach((el, i) => el.classList.toggle('active', i === dropdownActiveIdx));
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (dropdownActiveIdx >= 0 && items[dropdownActiveIdx]) {
      items[dropdownActiveIdx].dispatchEvent(new MouseEvent('mousedown'));
    } else {
      const val = document.getElementById('product-tag-input').value.trim();
      if (val && !tagState.products.includes(val)) {
        tagState.products.push(val);
        renderTagPills('products');
        document.getElementById('product-tag-input').value = '';
        dd.style.display = 'none';
      }
    }
  } else if (e.key === 'Escape') {
    dd.style.display = 'none';
  } else if (e.key === 'Backspace' && !document.getElementById('product-tag-input').value && tagState.products.length > 0) {
    tagState.products.pop();
    renderTagPills('products');
  }
}

// Close dropdown when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('.tag-input-outer')) {
    document.getElementById('product-dropdown').style.display = 'none';
  }
});

function renderTagPills(field) {
  const { wrap, input } = tagConfig[field];
  const wrapEl = document.getElementById(wrap);
  const inputEl = document.getElementById(input);
  wrapEl.querySelectorAll('.tag-pill').forEach(t => t.remove());
  tagState[field].forEach((val, i) => {
    const pill = document.createElement('div');
    pill.className = 'tag-pill';
    pill.innerHTML = val + '<span class="tag-pill-remove" onclick="removeTag(\''+field+'\','+i+')">‚úï</span>';
    wrapEl.insertBefore(pill, inputEl);
  });
  inputEl.placeholder = tagState[field].length === 0 ? 'Type and press Enter‚Ä¶' : 'Add more‚Ä¶';
}

function handleTagKey(e, field) {
  const input = e.target;
  if ((e.key === 'Enter' || e.key === ',') && input.value.trim()) {
    e.preventDefault();
    const val = input.value.trim().replace(/,$/, '');
    if (val && !tagState[field].includes(val)) {
      tagState[field].push(val);
      renderTagPills(field);
    }
    input.value = '';
  } else if (e.key === 'Backspace' && !input.value && tagState[field].length > 0) {
    tagState[field].pop();
    renderTagPills(field);
  }
}

function removeTag(field, idx) {
  tagState[field].splice(idx, 1);
  renderTagPills(field);
}

function resetTagFields() {
  tagState.products = [];
  tagState.crmOwners = [];
  tagState.mktOwners = [];
  renderTagPills('products');
  renderTagPills('crmOwners');
  renderTagPills('mktOwners');
}

function loadTagFields(task) {
  tagState.products  = Array.isArray(task.products)   ? [...task.products]   : (task.product   ? [task.product]   : []);
  tagState.crmOwners = Array.isArray(task.crmOwners)  ? [...task.crmOwners]  : (task.crmOwner  ? [task.crmOwner]  : []);
  tagState.mktOwners = Array.isArray(task.mktOwners)  ? [...task.mktOwners]  : (task.marketingOwner ? [task.marketingOwner] : []);
  renderTagPills('products');
  renderTagPills('crmOwners');
  renderTagPills('mktOwners');
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function showToast(msg) {
  const t = document.getElementById('crm-toast');
  t.textContent = msg; t.style.transform = 'translateY(0)'; t.style.opacity = '1';
  clearTimeout(window._ct);
  window._ct = setTimeout(() => { t.style.transform = 'translateY(80px)'; t.style.opacity = '0'; }, 2800);
}

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
// ‚îÄ‚îÄ Auth gate ‚îÄ‚îÄ
// authReady tracks whether Firebase has resolved the initial auth state
let authInitialised = false;

function lockApp() {
  // Hide everything, wipe data so nothing leaks
  document.querySelector('.app-layout').classList.remove('authenticated');
  tasks = [];
  if (currentView === 'archive') { currentView = 'all'; }
  // Show login overlay
  document.getElementById('auth-overlay').classList.add('open');
  document.getElementById('auth-error').classList.remove('show');
  document.getElementById('auth-password').value = '';
  setTimeout(() => { try { document.getElementById('auth-email').focus(); } catch(e){} }, 100);
}

function unlockApp() {
  document.getElementById('auth-overlay').classList.remove('open');
  document.querySelector('.app-layout').classList.add('authenticated');
}

auth.onAuthStateChanged(async user => {
  isAdmin = !!user;
  document.body.classList.toggle('is-admin', isAdmin);
  document.getElementById('admin-logged-in').style.display = isAdmin ? '' : 'none';
  document.getElementById('admin-logged-out').style.display = 'none';

  if (isAdmin) {
    unlockApp();
    await loadTasks();
    renderTasks();
    updateStats();
    populateFilters();
    startRealtimeSync();
  } else {
    lockApp();
  }
  authInitialised = true;
});

function showLoginModal() {
  document.getElementById('auth-overlay').classList.add('open');
  document.getElementById('auth-error').classList.remove('show');
  document.getElementById('auth-password').value = '';
  setTimeout(() => { try { document.getElementById('auth-email').focus(); } catch(e){} }, 100);
}

function hideLoginModal() {
  document.getElementById('auth-overlay').classList.remove('open');
}

async function doLogin() {
  const email = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  const btn = document.getElementById('auth-btn');
  const errEl = document.getElementById('auth-error');
  if (!email || !password) { errEl.textContent = 'Please enter email and password.'; errEl.classList.add('show'); return; }
  btn.disabled = true; btn.textContent = 'Signing in‚Ä¶'; errEl.classList.remove('show');
  try {
    await auth.signInWithEmailAndPassword(email, password);
    // onAuthStateChanged will handle unlocking
  } catch(e) {
    errEl.textContent = 'Incorrect email or password.'; errEl.classList.add('show');
    btn.disabled = false; btn.textContent = 'Sign In';
  }
}

async function doLogout() {
  _realtimeSyncStarted = false; // allow re-subscribe on next login
  await auth.signOut();
  // onAuthStateChanged fires ‚Üí lockApp()
}

// ‚îÄ‚îÄ Firebase load/save ‚îÄ‚îÄ
async function loadTasks() {
  try {
    const snap = await DATA_DOC.get();
    if (snap.exists) tasks = snap.data().tasks || [];
  } catch(e) { console.warn('Load failed', e); }
}

async function saveTasks() {
  if (!isAdmin) return;
  try {
    isSyncing = true;
    await DATA_DOC.set({ tasks: JSON.parse(JSON.stringify(tasks)), savedAt: new Date().toISOString() });
    showToast('‚úì Saved');
  } catch(e) { showToast('‚ö†Ô∏è Save failed'); }
  finally { isSyncing = false; }
}

// ‚îÄ‚îÄ Sidebar / view switching ‚îÄ‚îÄ
let currentView = 'all';      // 'all' | 'archive'
let sidebarStatusFilter = ''; // '' = all, or 'In Progress' etc.

function isArchived(task) {
  if (task.status !== 'Complete') return false;
  if (!task.dueDate) return true; // Complete + no due date ‚Üí archive
  const due = new Date(task.dueDate);
  const now = new Date(); now.setHours(0,0,0,0);
  const diff = Math.round((now - due) / 86400000);
  return diff >= 7; // Complete + due date 7+ days in past ‚Üí archive
}

function showView(view) {
  currentView = view;
  document.getElementById('main-view').classList.toggle('hidden', view === 'archive');
  document.getElementById('archive-view').classList.toggle('active', view === 'archive');

  // Sidebar nav highlight
  document.querySelectorAll('.sidebar-nav-item').forEach(el => {
    if (['snav-all','snav-archive'].includes(el.id)) el.classList.remove('active');
  });
  document.getElementById('snav-' + (view === 'archive' ? 'archive' : 'all')).classList.add('active');

  if (view === 'archive') renderArchive();
  else { filterTasks(); }
}

function setSidebarFilter(status) {
  sidebarStatusFilter = status === 'all' ? '' : status;
  // Switch to main view if on archive
  if (currentView === 'archive') showView('all');

  // Update sidebar highlights ‚Äî clear status items then set active
  ['snav-all-status','snav-inprogress','snav-notstarted','snav-complete','snav-onhold'].forEach(id => {
    document.getElementById(id)?.classList.remove('active');
  });
  const map = { '': 'snav-all-status', 'In Progress': 'snav-inprogress', 'Not Started': 'snav-notstarted', 'Complete': 'snav-complete', 'On Hold': 'snav-onhold' };
  if (map[sidebarStatusFilter]) document.getElementById(map[sidebarStatusFilter]).classList.add('active');

  // Push filter into the existing status dropdown so getFilteredTasks picks it up
  const sel = document.getElementById('status-filter');
  if (sel) sel.value = sidebarStatusFilter;
  filterTasks();
}

function renderArchive() {
  const archived = tasks.filter(isArchived);
  const list = document.getElementById('archive-list');
  if (!archived.length) {
    list.innerHTML = `<div style="text-align:center;padding:60px 20px;color:var(--text3)">
      <div style="font-size:48px;margin-bottom:12px">üóÇÔ∏è</div>
      <div style="font-family:'Syne',sans-serif;font-size:16px;color:var(--text2);margin-bottom:6px">Archive is empty</div>
      <div style="font-size:13px">Completed tasks with a due date 7+ days ago (or no due date) will appear here.</div>
    </div>`;
    return;
  }

  // Group by year of due date (or "No Due Date")
  const byGroup = {};
  archived.forEach(t => {
    const grp = t.dueDate ? new Date(t.dueDate).getFullYear().toString() : 'No Due Date';
    if (!byGroup[grp]) byGroup[grp] = [];
    byGroup[grp].push(t);
  });
  const sortedGroups = Object.keys(byGroup).sort((a,b) => b === 'No Due Date' ? -1 : a === 'No Due Date' ? 1 : b - a);

  list.innerHTML = sortedGroups.map(grp => `
    <div style="margin-bottom:24px">
      <div style="font-size:11px;font-weight:600;letter-spacing:1.2px;text-transform:uppercase;color:var(--text3);padding-bottom:8px;border-bottom:1px solid var(--border);margin-bottom:10px">
        üìÅ ${grp} ¬∑ ${byGroup[grp].length} task${byGroup[grp].length !== 1 ? 's' : ''}
      </div>
      ${byGroup[grp].map(task => {
        const products = (task.products || (task.product ? [task.product] : [])).filter(Boolean);
        const crm = (task.crmOwners || (task.crmOwner ? [task.crmOwner] : [])).filter(Boolean);
        const mkt = (task.mktOwners || (task.marketingOwner ? [task.marketingOwner] : [])).filter(Boolean);
        const dueStr = task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : '‚Äî';
        const latestNote = task.notes && task.notes.length > 0 ? task.notes[0] : null;
        return `<div class="archive-card" onclick="openTaskModal(${task.id})">
          <div style="width:36px;height:36px;border-radius:10px;background:rgba(34,217,146,0.12);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">‚úÖ</div>
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap">
              <span style="font-family:'Syne',sans-serif;font-weight:700;font-size:14px;color:var(--text)">${task.subject || 'Untitled'}</span>
              ${products.map(p => `<span class="product-badge" style="font-size:10px;padding:2px 7px">${p}</span>`).join('')}
              ${task.jiraLink ? `<a href="${task.jiraLink}" target="_blank" class="jira-link" style="font-size:10px;padding:2px 7px" onclick="event.stopPropagation()">üîó Jira</a>` : ''}
            </div>
            ${task.description ? `<div style="font-size:12px;color:var(--text3);margin-bottom:4px">${task.description.substring(0,100)}${task.description.length>100?'‚Ä¶':''}</div>` : ''}
            ${latestNote ? `<div style="font-size:11px;color:var(--text3);display:flex;gap:5px;align-items:flex-start"><span>üí¨</span><span style="font-size:10px;white-space:nowrap">${new Date(latestNote.timestamp).toLocaleDateString('en-GB',{day:'numeric',month:'short'})}</span><span style="flex:1;word-break:break-word">${latestNote.text.substring(0,120)}${latestNote.text.length>120?'‚Ä¶':''}</span></div>` : ''}
          </div>
          <div style="text-align:right;flex-shrink:0;font-size:11px;color:var(--text3)">
            <div style="margin-bottom:4px">üìÖ ${dueStr}</div>
            ${crm.length ? `<div>üë§ ${crm.join(', ')}</div>` : ''}
            ${mkt.length ? `<div>üì± ${mkt.join(', ')}</div>` : ''}
          </div>
        </div>`;
      }).join('')}
    </div>
  `).join('');
}

function updateSidebarStats() {
  const active = tasks.filter(t => !isArchived(t));
  document.getElementById('sb-total').textContent = active.length;
  document.getElementById('sb-complete').textContent = active.filter(t => t.status === 'Complete').length;
  document.getElementById('sb-progress').textContent = active.filter(t => t.status === 'In Progress').length;
  document.getElementById('sb-notstarted').textContent = active.filter(t => t.status === 'Not Started').length;
  const archived = tasks.filter(isArchived);
  document.getElementById('archive-badge').textContent = archived.length;
}

let _realtimeSyncStarted = false;
function startRealtimeSync() {
  if (_realtimeSyncStarted) return;
  _realtimeSyncStarted = true;
  DATA_DOC.onSnapshot(snap => {
    if (isSyncing || !snap.exists) return;
    const incoming = snap.data().tasks || [];
    if (JSON.stringify(incoming) !== JSON.stringify(tasks)) {
      tasks = incoming;
      renderTasks(); updateStats(); populateFilters();
      showToast('üîÑ Synced');
    }
  });
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
  // App stays hidden (display:none via CSS) until onAuthStateChanged resolves.
  // No data is loaded, no UI is rendered until Firebase confirms a valid session.
});

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
function updateStats() {
  const active = tasks.filter(t => !isArchived(t));
  const archived = tasks.filter(t => isArchived(t));
  document.getElementById('stat-total').textContent = tasks.length;
  document.getElementById('stat-complete').textContent = active.filter(t => t.status === 'Complete').length + archived.length;
  document.getElementById('stat-progress').textContent = active.filter(t => t.status === 'In Progress').length;
  document.getElementById('stat-not-started').textContent = active.filter(t => t.status === 'Not Started').length;
  updateSidebarStats();
}

// ‚îÄ‚îÄ Filters ‚îÄ‚îÄ
function populateFilters() {
  const products = new Set(tasks.flatMap(t => t.products || (t.product ? [t.product] : [])));
  const owners = new Set(tasks.flatMap(t => [
    ...(t.crmOwners || (t.crmOwner ? [t.crmOwner] : [])),
    ...(t.mktOwners || (t.marketingOwner ? [t.marketingOwner] : []))
  ]));
  const pf = document.getElementById('product-filter');
  const of_ = document.getElementById('owner-filter');
  pf.innerHTML = '<option value="">All Products</option>';
  of_.innerHTML = '<option value="">All Owners</option>';
  products.forEach(p => { const o = document.createElement('option'); o.value = o.textContent = p; pf.appendChild(o); });
  owners.forEach(p => { const o = document.createElement('option'); o.value = o.textContent = p; of_.appendChild(o); });
}

function filterTasks() { renderTasks(); }

function getFilteredTasks() {
  const s = document.getElementById('search-input').value.toLowerCase();
  const pf = document.getElementById('product-filter').value;
  const sf = document.getElementById('status-filter').value;
  const of_ = document.getElementById('owner-filter').value;
  return tasks.filter(t =>
    !isArchived(t) &&
    (!s || (t.subject||'').toLowerCase().includes(s) || (t.description||'').toLowerCase().includes(s) || (t.product||'').toLowerCase().includes(s)) &&
    (!pf || t.product === pf) &&
    (!sf || t.status === sf) &&
    (!of_ || t.crmOwner === of_ || t.marketingOwner === of_)
  );
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function renderTasks() {
  const tbody = document.getElementById('tasks-tbody');
  const mobileCards = document.getElementById('mobile-cards');
  const filtered = getFilteredTasks();

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><div class="empty-icon">üîç</div><div>No tasks match your filters.</div></td></tr>`;
    mobileCards.innerHTML = `<div class="empty-state" style="padding:40px 20px"><div class="empty-icon">üîç</div><div>No tasks match your filters.</div></div>`;
    return;
  }

  tbody.innerHTML = filtered.map(task => {
    const sc = task.status === 'Complete' ? 'status-complete' : task.status === 'In Progress' ? 'status-in-progress' : task.status === 'On Hold' ? 'status-on-hold' : 'status-not-started';
    const dd = task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-GB', {day:'numeric',month:'short',year:'numeric'}) : '‚Äî';
    const ln = task.notes && task.notes.length > 0 ? task.notes[0] : null;
    const np = ln ? `<div style="display:flex;align-items:flex-start;gap:6px;margin-top:6px;padding:6px 10px;background:var(--navy3);border:1px solid var(--border);border-radius:6px"><span style="font-size:13px;color:#c8d4e0;flex-shrink:0;margin-top:1px">üí¨</span><span style="font-size:12px;color:#c8d4e0;flex-shrink:0;white-space:nowrap;margin-top:1px">${new Date(ln.timestamp).toLocaleDateString('en-GB',{day:'numeric',month:'short'})}</span><span style="font-size:13px;color:#c8d4e0;flex:1;white-space:normal;word-break:break-word;line-height:1.6">${ln.text}</span></div>` : '';
    return `<tr onclick="openTaskModal(${task.id})">
      <td>${(task.products||[task.product]).filter(Boolean).map(p=>`<span class="product-badge" style="margin-right:3px">${p}</span>`).join('')||'‚Äî'}</td>
      <td><div style="display:flex;align-items:center;gap:8px;margin-bottom:2px"><div style="font-weight:700;color:#ffffff">${task.subject||'Untitled'}</div>${task.jiraLink?`<a href="${task.jiraLink}" target="_blank" class="jira-link" onclick="event.stopPropagation()">üîó Jira</a>`:''}</div>${task.description?`<div style="font-size:12px;color:var(--blue-light);font-weight:600;white-space:normal;word-break:break-word">${task.description}</div>`:''}${np}</td>
      <td>${(task.crmOwners||[task.crmOwner]).filter(Boolean).map(o=>`<span class="owner-badge" style="margin-bottom:2px">üë§ ${o}</span>`).join('<br>')||'‚Äî'}</td>
      <td>${(task.mktOwners||[task.marketingOwner]).filter(Boolean).map(o=>`<span class="owner-badge" style="margin-bottom:2px">üë§ ${o}</span>`).join('<br>')||'‚Äî'}</td>
      <td><span class="status-badge ${sc}"><span style="width:6px;height:6px;border-radius:50%;background:currentColor"></span>${task.status}</span></td>
      <td>${dd}</td><td>‚Äî</td></tr>`;
  }).join('');

  mobileCards.innerHTML = filtered.map(task => {
    const sc = task.status === 'Complete' ? 'status-complete' : task.status === 'In Progress' ? 'status-in-progress' : task.status === 'On Hold' ? 'status-on-hold' : 'status-not-started';
    const dd = task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-GB',{day:'numeric',month:'short'}) : 'No due date';
    const ln = task.notes && task.notes.length > 0 ? task.notes[0] : null;
    return `<div class="task-card" onclick="openTaskModal(${task.id})">
      <div class="task-card-header"><div class="task-card-title">${task.subject||'Untitled'}</div><span class="status-badge ${sc}" style="font-size:10px;padding:4px 8px"><span style="width:5px;height:5px;border-radius:50%;background:currentColor"></span>${task.status}</span></div>
      ${task.description?`<div class="task-card-body" style="white-space:normal;word-break:break-word">${task.description}</div>`:''}
      ${ln?`<div style="background:var(--navy3);border:1px solid var(--border);border-radius:6px;padding:10px;margin-bottom:12px"><div style="display:flex;align-items:flex-start;gap:8px"><span style="font-size:13px;color:#c8d4e0;flex-shrink:0;margin-top:1px">üí¨</span><span style="font-size:12px;color:#c8d4e0;flex-shrink:0;white-space:nowrap;margin-top:1px">${new Date(ln.timestamp).toLocaleDateString('en-GB',{day:'numeric',month:'short'})}</span><span style="font-size:13px;color:#c8d4e0;flex:1;line-height:1.6;white-space:normal;word-break:break-word">${ln.text}</span></div></div>`:''}
      <div class="task-card-meta">${(task.products||[task.product]).filter(Boolean).map(p=>`<span class="product-badge" style="font-size:10px;padding:3px 8px">${p}</span>`).join('')}${task.jiraLink?`<a href="${task.jiraLink}" target="_blank" class="jira-link" style="font-size:10px;padding:3px 8px" onclick="event.stopPropagation()">üîó Jira</a>`:''}</div>
      <div class="task-card-footer"><div class="task-card-owners">${(task.crmOwners||[task.crmOwner]).filter(Boolean).map(o=>`<div>üë§ CRM: <span style="color:var(--text2);font-weight:500">${o}</span></div>`).join('')}${(task.mktOwners||[task.marketingOwner]).filter(Boolean).map(o=>`<div>üì± Mktg: <span style="color:var(--text2);font-weight:500">${o}</span></div>`).join('')}</div><div style="text-align:right;font-size:11px;color:var(--text3)">üìÖ ${dd}</div></div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Modals ‚îÄ‚îÄ
function openAddModal() {
  if (!isAdmin) { showToast('üîí Admin login required'); showLoginModal(); return; }
  editingTaskId = null;
  document.getElementById('modal-title').textContent = 'Add New Task';
  document.getElementById('save-btn-text').textContent = 'Save Task';
  document.getElementById('delete-btn').style.display = 'none';
  ['input-subject','input-description','input-due-date','input-data-required','input-jira'].forEach(id => document.getElementById(id).value = '');
  resetTagFields();
  document.getElementById('input-status').value = 'Not Started';
  document.getElementById('input-risk').value = '';
  document.getElementById('notes-section-top').style.display = 'none';
  document.getElementById('task-modal').classList.add('open');
}

function openTaskModal(taskId) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;
  editingTaskId = taskId;
  document.getElementById('modal-title').textContent = 'Edit Task';
  document.getElementById('save-btn-text').textContent = 'Update Task';
  document.getElementById('delete-btn').style.display = isAdmin ? 'block' : 'none';
  loadTagFields(task);
  document.getElementById('input-subject').value = task.subject || '';
  document.getElementById('input-description').value = task.description || '';
  document.getElementById('input-status').value = task.status || 'Not Started';
  document.getElementById('input-due-date').value = task.dueDate || '';
  document.getElementById('input-risk').value = task.risk || '';
  document.getElementById('input-data-required').value = task.dataRequired || '';
  document.getElementById('input-jira').value = task.jiraLink || '';
  document.getElementById('notes-section-top').style.display = 'block';
  renderNotes(task.notes || [], 'notes-list-top');
  document.getElementById('task-modal').classList.add('open');
}

function renderNotes(notes, targetId) {
  const el = document.getElementById(targetId);
  if (!notes || !notes.length) { el.innerHTML = '<div style="color:var(--text3);font-size:13px;text-align:center;padding:20px">No notes yet.</div>'; return; }
  el.innerHTML = notes.map(n => `<div class="note-item"><div class="note-header"><div class="note-date">${new Date(n.timestamp).toLocaleString('en-GB',{day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'})}</div></div><div class="note-text">${n.text}</div></div>`).join('');
}

async function addNote() {
  if (!isAdmin) { showToast('üîí Admin login required'); showLoginModal(); return; }
  const input = document.getElementById('new-note-input-top');
  const text = input.value.trim();
  if (!text) return;
  const task = tasks.find(t => t.id === editingTaskId);
  if (!task) return;
  if (!task.notes) task.notes = [];
  task.notes.unshift({ text, timestamp: new Date().toISOString() });
  await saveTasks();
  renderNotes(task.notes, 'notes-list-top');
  renderTasks();
  input.value = '';
}

async function saveTask() {
  if (!isAdmin) { showToast('üîí Admin login required'); showLoginModal(); return; }
  const subject = document.getElementById('input-subject').value.trim();
  if (!subject) { alert('Please enter a subject'); return; }
  const data = {
    products: [...tagState.products],
    product: tagState.products[0] || '',
    crmOwners: [...tagState.crmOwners],
    crmOwner: tagState.crmOwners[0] || '',
    mktOwners: [...tagState.mktOwners],
    marketingOwner: tagState.mktOwners[0] || '',
    subject,
    description: document.getElementById('input-description').value.trim(),
    status: document.getElementById('input-status').value,
    dueDate: document.getElementById('input-due-date').value,
    risk: document.getElementById('input-risk').value,
    dataRequired: document.getElementById('input-data-required').value.trim(),
    jiraLink: document.getElementById('input-jira').value.trim(),
    updatedAt: new Date().toISOString()
  };
  if (editingTaskId) {
    const task = tasks.find(t => t.id === editingTaskId);
    Object.assign(task, data);
  } else {
    tasks.push({ id: Date.now(), ...data, notes: [], createdAt: new Date().toISOString() });
  }
  await saveTasks(); renderTasks(); updateStats(); populateFilters(); closeModal();
}

async function deleteTask() {
  if (!isAdmin) { showToast('üîí Admin login required'); showLoginModal(); return; }
  if (!confirm('Delete this task?')) return;
  tasks = tasks.filter(t => t.id !== editingTaskId);
  await saveTasks(); renderTasks(); updateStats(); populateFilters(); closeModal();
}

function closeModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('task-modal').classList.remove('open');
  document.getElementById('new-note-input-top').value = '';
}

function exportToJSON() {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([JSON.stringify(tasks, null, 2)], {type:'application/json'}));
  a.download = `dmg-crm-tasks-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const imported = JSON.parse(e.target.result);
      if (!Array.isArray(imported)) { alert('Invalid format.'); return; }
      const merge = confirm(`Import ${imported.length} tasks?
OK = Add to existing
Cancel = Replace all`);
      if (merge) {
        const maxId = tasks.length ? Math.max(...tasks.map(t => t.id)) : 0;
        tasks = [...tasks, ...imported.map((t,i) => ({...t, id: maxId+i+1}))];
      } else { tasks = imported; }
      await saveTasks(); renderTasks(); updateStats(); populateFilters();
      alert('‚úÖ Import successful!');
    } catch(e) { alert('‚ùå Invalid JSON file.'); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); document.getElementById('search-input').focus(); }
});
</script>

<!-- Toast -->
<div id="crm-toast" style="position:fixed;bottom:24px;right:24px;background:#1e3050;border:1px solid rgba(255,255,255,0.12);border-radius:12px;padding:12px 18px;font-size:13px;color:#e8edf5;z-index:9999;transform:translateY(80px);opacity:0;transition:all 0.3s;box-shadow:0 8px 30px rgba(0,0,0,0.4)"></div>

<!-- Admin Login Modal -->
<div class="auth-overlay" id="auth-overlay">
  <div class="auth-card">
    <div class="auth-logo"><div class="auth-logo-icon">üîê</div></div>
    <div class="auth-title">Admin Login</div>
    <div class="auth-subtitle">Sign in to access the CRM Tracker</div>
    <div class="auth-error" id="auth-error"></div>
    <div class="auth-field">
      <label class="auth-label">Email</label>
      <input class="auth-input" id="auth-email" type="email" placeholder="admin@example.com" autocomplete="username">
    </div>
    <div class="auth-field">
      <label class="auth-label">Password</label>
      <input class="auth-input" id="auth-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="auth-btn" id="auth-btn" onclick="doLogin()">Sign In</button>
  </div>
</div>
</body>
</html>
